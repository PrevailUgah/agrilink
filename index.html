<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriLink Command Center</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        
        const { useState } = React;
        

        // --- Inline Icons ---
        const Icon = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Send = (p) => <Icon {...p}><path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" /></Icon>;
        const Truck = (p) => <Icon {...p}><path d="M14 18V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2" /><path d="M15 18H9" /><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14" /><circle cx="17" cy="18" r="2" /><circle cx="7" cy="18" r="2" /></Icon>;
        const Cpu = (p) => <Icon {...p}><rect x="4" y="4" width="16" height="16" rx="2" /><rect x="9" y="9" width="6" height="6" /><path d="M9 1V3"/><path d="M15 1V3"/><path d="M9 21V23"/><path d="M15 21V23"/><path d="M20 9H22"/><path d="M20 15H22"/><path d="M2 9H4"/><path d="M2 15H4"/></Icon>;
        const Database = (p) => <Icon {...p}><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M3 5V19A9 3 0 0 0 21 19V5" /><path d="M3 12A9 3 0 0 0 21 12" /></Icon>;

        const App = () => {
            const [message, setMessage] = useState("Hello, I have 500 baskets of onions in Kano ready for pickup.");
            const [loading, setLoading] = useState(false);
            const [logs, setLogs] = useState([]);
            const [result, setResult] = useState(null);

            const addToLog = (text) => {
                setLogs(prev => [...prev, `> ${text}`]);
            };

            // --- CLIENT-SIDE LOGIC ENGINE (FALLBACK) ---
            // This ensures the demo works even if the Python backend is offline
            const simulateSmartLogic = (text) => {
                const lowerText = text.toLowerCase();
                let product = "unknown";
                let location = "unknown";
                
                // Simulate NLP Extraction
                if (lowerText.includes("onion")) product = "onions";
                else if (lowerText.includes("tomato")) product = "tomatoes";
                else if (lowerText.includes("pepper")) product = "pepper";
                
                if (lowerText.includes("kano")) location = "kano";
                else if (lowerText.includes("lagos")) location = "lagos";
                else if (lowerText.includes("zaria")) location = "zaria";
                else if (lowerText.includes("abuja")) location = "abuja";

                // Simulate Database Matching
                let buyer = "None";
                let payout = 0;
                let status = "PENDING_WAREHOUSE";

                // Logic: Matches based on simplified business rules
                if (location === "kano" && product === "onions") {
                    buyer = "Kano Central Market";
                    payout = 7000 * 500; // Mock calculation
                    status = "DISPATCH_APPROVED";
                } else if (location === "zaria" && product === "tomatoes") {
                    buyer = "Alhaji Musa Processing";
                    payout = 5000 * 50;
                    status = "DISPATCH_APPROVED";
                } else if (location === "lagos") {
                    buyer = "Lagos Mile 12 Aggregator";
                    payout = 12000 * 100;
                    status = "DISPATCH_APPROVED";
                }

                return {
                    status: status,
                    extracted_data: { product, location },
                    matched_buyer: buyer,
                    estimated_payout: payout,
                    route_id: `RTE-SIM-${Math.floor(Math.random() * 9000) + 1000}`
                };
            };

            const handleSend = async () => {
                setLoading(true);
                setLogs([]);
                setResult(null);
                
                addToLog("Receiving encrypted packet from WhatsApp Gateway...");
                addToLog("Initiating Neural Core...");

                // Simulate Network Delay for realism
                setTimeout(async () => {
                    let data;
                    try {
                        // Try connecting to Python Backend
                        const response = await fetch("http://127.0.0.1:8000/analyze-dispatch", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ farmer_name: "Ibrahim Sadiq", message: message })
                        });
                        if (!response.ok) throw new Error("Backend offline");
                        data = await response.json();
                        addToLog("Connected to Python Neural Engine.");
                    } catch (err) {
                        // Fallback to Smart Client Simulation
                        console.warn("Backend unavailable. Using Client-Side Neural Simulation.");
                        addToLog("Server Unreachable. Engaging Client-Side Fallback Logic...");
                        data = simulateSmartLogic(message);
                    }

                    // Process Data
                    addToLog("Extraction Complete.");
                    if(data.extracted_data) {
                        addToLog(`Detected Product: ${data.extracted_data.product.toUpperCase()}`);
                        addToLog(`Detected Location: ${data.extracted_data.location.toUpperCase()}`);
                    }
                    
                    if (data.status === "DISPATCH_APPROVED") {
                        addToLog(`MATCH FOUND: ${data.matched_buyer}`);
                        addToLog(`Routing Truck... ID: ${data.route_id}`);
                    } else {
                        addToLog("NO BUYER MATCH FOUND. Queuing item.");
                    }

                    setResult(data);
                    setLoading(false);
                }, 1500);
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">
                    {/* LEFT PANEL */}
                    <div className="w-full md:w-1/3 bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-2xl flex flex-col">
                        <div className="flex items-center gap-3 mb-6 border-b border-slate-700 pb-4">
                            <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">IS</div>
                            <div>
                                <h3 className="font-bold text-white">Ibrahim Sadiq</h3>
                                <p className="text-xs text-green-400 flex items-center gap-1"><span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Online • Mobile</p>
                            </div>
                        </div>
                        <div className="flex-grow bg-slate-900 rounded-lg p-4 mb-4 text-sm text-slate-300">
                            <p className="bg-slate-800 p-3 rounded-tr-xl rounded-bl-xl rounded-br-xl inline-block">Good morning. Are you buying today?</p>
                        </div>
                        <div className="relative">
                            <textarea 
                                value={message}
                                onChange={(e) => setMessage(e.target.value)}
                                className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 focus:border-green-500 focus:outline-none text-sm h-24 resize-none"
                            ></textarea>
                            <button onClick={handleSend} disabled={loading} className="absolute bottom-3 right-3 bg-green-600 hover:bg-green-500 text-white p-2 rounded-full transition disabled:opacity-50 flex items-center justify-center">
                                <Send size={18} />
                            </button>
                        </div>
                    </div>

                    {/* RIGHT PANEL */}
                    <div className="w-full md:w-2/3 flex flex-col gap-6">
                        <div className="grid grid-cols-3 gap-4">
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex items-center gap-4">
                                <div className="text-blue-400"><Cpu /></div>
                                <div><p className="text-xs text-slate-400">NEURAL CORE</p><p className="font-bold text-white">Active</p></div>
                            </div>
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex items-center gap-4">
                                <div className="text-purple-400"><Database /></div>
                                <div><p className="text-xs text-slate-400">BUYERS</p><p className="font-bold text-white">Connected</p></div>
                            </div>
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex items-center gap-4">
                                <div className="text-orange-400"><Truck /></div>
                                <div><p className="text-xs text-slate-400">FLEET</p><p className="font-bold text-white">Standby</p></div>
                            </div>
                        </div>

                        <div className="bg-black rounded-xl p-6 border border-slate-700 flex-grow font-mono text-xs md:text-sm text-green-400 overflow-hidden relative shadow-2xl min-h-[200px]">
                            <div className="absolute top-2 right-4 text-slate-600 text-xs">SYSTEM LOGS</div>
                            <div className="space-y-2 h-full overflow-y-auto pb-4">
                                {logs.map((log, index) => (
                                    <div key={index} className="opacity-90 border-l-2 border-green-900 pl-2 animate-pulse">{log}</div>
                                ))}
                                {loading && <div className="animate-pulse">_ Processing data stream...</div>}
                            </div>
                        </div>

                        {result && (
                            <div className={`p-6 rounded-xl border-l-4 shadow-lg ${result.status === 'DISPATCH_APPROVED' ? 'bg-green-900/20 border-green-500' : 'bg-yellow-900/20 border-yellow-500'}`}>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h2 className={`text-xl font-bold mb-1 ${result.status === 'DISPATCH_APPROVED' ? 'text-green-400' : 'text-yellow-400'}`}>
                                            {result.status.replace('_', ' ')}
                                        </h2>
                                        <p className="text-slate-400 text-sm">Action queued in ledger.</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xs text-slate-500 uppercase tracking-widest">Est. Payout</p>
                                        <p className="text-2xl font-bold text-white">₦{result.estimated_payout.toLocaleString()}</p>
                                    </div>
                                </div>
                                {result.matched_buyer && (
                                    <div className="mt-4 pt-4 border-t border-slate-700/50 flex items-center gap-3">
                                        <Truck size={18} className="text-slate-400" />
                                        <span className="text-white">Route assigned to: <strong>{result.matched_buyer}</strong></span>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>